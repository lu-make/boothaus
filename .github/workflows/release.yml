name: Build & Draft Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

env:
  PROJECT_PATH: Boothaus.GUI/Boothaus.GUI.csproj
  APP_NAME: Boothaus

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        rid: [win-x86, win-x64, win-arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        shell: pwsh
        run: |
          $refName = "${{ github.ref_name }}"   # z.B. v1.0.4
          $version = $refName.TrimStart('v')    # 1.0.4
          "VERSION=$version" >> $env:GITHUB_ENV

      - name: Debug VERSION
        shell: pwsh
        run: echo "VERSION is $env:VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish ${{ matrix.rid }}
        shell: pwsh
        run: >
          dotnet publish
          $env:PROJECT_PATH
          -c Release
          -r ${{ matrix.rid }}
          --self-contained false
          -p:PublishSingleFile=true
          -p:Version=$env:VERSION
          -p:AssemblyVersion=$env:VERSION
          -p:FileVersion=$env:VERSION

      - name: ZIP only exe
        shell: pwsh
        run: |
          $rid = "${{ matrix.rid }}"        # z.B. win-x64
          $arch = $rid.Replace("win-","")   # x86 / x64 / arm64

          $publishDir = "Boothaus.GUI/bin/Release/net9.0-windows/$rid/publish"

          # Nimm die erste EXE aus dem Publish-Ordner
          $exe = Get-ChildItem $publishDir -Filter *.exe | Select-Object -First 1

          if (-not $exe) {
            Write-Error "Keine EXE im Publish-Ordner gefunden: $publishDir"
            exit 1
          }

          $zipName = "$($env:APP_NAME)_v$($env:VERSION)_$arch.zip"
          Compress-Archive -Path $exe.FullName -DestinationPath $zipName -Force

          Write-Host "Erzeugt: $zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zips-${{ matrix.rid }}
          path: '*.zip'

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create draft release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}       # z.B. v1.0.4
          release_name: ${{ github.ref_name }}   # oder: Boothaus ${{ github.ref_name }}
          draft: true
          prerelease: false
          body: ""

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
        run: |
          for file in dist/**/*.zip; do
            echo "Uploading $file"
            name=$(basename "$file")
            curl \
              -sSL \
              -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$file" \
              "${UPLOAD_URL%%\{*}?name=$name"
          done
