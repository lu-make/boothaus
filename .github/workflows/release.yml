name: Build & Draft Release

on:
  push:
    tags:
      # z.B. v1.0.3, v2.1.0 usw.
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  # Tag-Name ist gleichzeitig die Versionsnummer, z.B. "1.0.4"
  VERSION: ${{ github.ref_name }}
  # Dein Projektpfad
  PROJECT_PATH: src/Anwendung/Anwendung.csproj
  # Dein Anzeigename für das Programm (für die ZIP-Dateien)
  APP_NAME: Anwendung

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        rid: [win-x86, win-x64, win-arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish ${{ matrix.rid }}
        run: >
          dotnet publish
          $env:PROJECT_PATH
          -c Release
          -r ${{ matrix.rid }}
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:Version=$env:VERSION
          -p:AssemblyVersion=$env:VERSION
          -p:FileVersion=$env:VERSION

      - name: ZIP only exe
        shell: pwsh
        run: |
          $rid = "${{ matrix.rid }}"        # z.B. win-x64
          $arch = $rid.Replace("win-","")   # x86 / x64 / arm64

          # Passe den TargetFramework ggf. an (z.B. net7.0-windows)
          $publishDir = "src/Anwendung/bin/Release/net8.0-windows/$rid/publish"

          # Nimm die erste EXE aus dem Publish-Ordner
          $exe = Get-ChildItem $publishDir -Filter *.exe | Select-Object -First 1

          if (-not $exe) {
            Write-Error "Keine EXE im Publish-Ordner gefunden: $publishDir"
            exit 1
          }

          $zipName = "$($env:APP_NAME)_v$($env:VERSION)_$arch.zip"
          Compress-Archive -Path $exe.FullName -DestinationPath $zipName -Force

          Write-Host "Erzeugt: $zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zips
          path: '*.zip'

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: zips
          path: dist

      - name: Create draft release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: v${{ env.VERSION }}
          draft: true
          prerelease: false
          body: ""   # Release Notes bleiben leer, bearbeitest du später

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
        run: |
          for file in dist/*.zip; do
            echo "Uploading $file"
            name=$(basename "$file")
            curl \
              -sSL \
              -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$file" \
              "${UPLOAD_URL%%\{*}?name=$name"
          done

